{{>layouts/header}}

<h1>Stream Viewer</h1>
<img id="stream" src="http://175.123.202.85:20800/stream.mjpg" alt="Stream not available">

<h1>UDP Streaming</h1>
<div>
    <button onclick="fetchSensorData()">Get Sensor Data</button>
    <div id="sensorData"></div>
    <button onclick="fetchRotaterData()">Get Rotater Data</button>
    <div id="rotaterData"></div>
    <button onclick="fetchSprinklerData()">Get Sprinkler Data</button>
    <div id="sprinklerData"></div>
    <button onclick="fetchLedData()">Get LED Data</button>
    <div id="ledData"></div>
    <button id="fetchUdpDataButton">Capture Screenshot</button>
    <div id="udpDataContainer" style="display: none;">
        <h3>Captured Screenshot</h3>
        <img id="udpScreenshot" alt="Screenshot not available">
    </div>
</div>

<script>
    function fetchSensorData() {
        const url = '/api/udp/sensor';
        fetchAndDisplayData(url, 'sensorData', 'Sensor');
    }

    function fetchRotaterData() {
        const url = '/api/udp/rotater';
        fetchAndDisplayData(url, 'rotaterData', 'Rotater');
    }

    function fetchSprinklerData() {
        const url = '/api/udp/sprinkler';
        fetchAndDisplayData(url, 'sprinklerData', 'Sprinkler');
    }

    function fetchLedData() {
        const url = '/api/udp/led';
        fetchAndDisplayData(url, 'ledData', 'LED');
    }

    function fetchAndDisplayData(url, containerId, dataTypeName) {
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById(containerId);
                container.textContent = JSON.stringify(data);

                const dataTypeInfo = document.createElement('p');
                dataTypeInfo.textContent = `${dataTypeName} Data`;
                container.prepend(dataTypeInfo);
            })
            .catch(error => console.error(`Error fetching ${containerId} data:`, error));
    }

    //스크린샷
    const fetchUdpDataButton = document.getElementById('fetchUdpDataButton');
    const udpDataContainer = document.getElementById('udpDataContainer');
    const udpScreenshotElement = document.getElementById('udpScreenshot');

    fetchUdpDataButton.onclick = function() {
        fetch('/api/start-udp')
            .then(response => {
                console.log('start-udp response:', response);
                return response.json();
            })
            .then(data => {
                console.log('start-udp data:', data);
                if (data.status === 'success') {
                    return new Promise(resolve => setTimeout(resolve, 1000))  // 1초 대기 후 데이터 요청
                        .then(() => fetch('/api/udp-data'))
                        .then(response => response.json())
                        .then(data => {
                            if (data.screenshot) {
                                udpScreenshotElement.src = 'data:image/jpeg;base64,' + data.screenshot;
                            }
                            udpDataContainer.style.display = 'block';  // 데이터 수신 후 컨테이너를 보여줍니다.
                        });
                } else {
                    console.error('Error starting UDP capture:', data.message);
                }
            })
            .catch(error => console.error('Error fetching screenshot:', error));
    };
</script>